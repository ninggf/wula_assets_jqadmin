layui.define(["table","jquery","form"],function(e){"use strict";var t="tableSelect",a=layui.jquery,c=layui.table,l=layui.form,n=function(){this.v="1.1.0"};n.prototype.render=function(e){var t=a(e.elem),n=e.table.done||function(){};e.searchKey=e.searchKey||"keyword",e.searchPlaceholder=e.searchPlaceholder||"关键词搜索",e.checkedKey=e.checkedKey,e.table.page=e.table.page||!0,e.table.height=e.table.height||315,t.off("click").on("click",function(i){function o(t,l,n){for(var i=0;i<t.data.length;i++)for(var o=0;o<y.length;o++)if(t.data[i][e.checkedKey]==y[o][e.checkedKey]){t.data[i].LAY_CHECKED=!0;var r=t.data[i].LAY_TABLE_INDEX,h=a("#"+p).next().find("tr[data-index="+r+'] input[type="checkbox"]');h.prop("checked",!0).next().addClass("layui-form-checked");var s=a("#"+p).next().find("tr[data-index="+r+'] input[type="radio"]');s.prop("checked",!0).next().addClass("layui-form-radioed").find("i").html("&#xe643;")}var u=c.checkStatus(p);u.isAll&&(a("#"+p).next().find('.layui-table-header th[data-field="0"] input[type="checkbox"]').prop("checked",!0),a("#"+p).next().find('.layui-table-header th[data-field="0"] input[type="checkbox"]').next().addClass("layui-form-checked")),d(y.length)}function r(a,c,l){if(e.checkedKey&&t.attr("ts-selected")){for(var n=t.attr("ts-selected").split(","),i=0;i<a.data.length;i++)for(var o=0;o<n.length;o++)a.data[i][e.checkedKey]==n[o]&&y.push(a.data[i]);y=h(y,e.checkedKey)}}function d(e){b.find(".tableSelect_btn_select span").html(0==e?"":"("+e+")")}function h(e,t){var a=[],c=[];if(0==e.length)return e;if(t){for(var l=0;l<e.length;l++)c[e[l][t]]||(a.push(e[l]),c[e[l][t]]=!0);return a}for(var l=0;l<e.length;l++)c[e[l]]||(a.push(e[l]),c[e[l]]=!0);return a}function s(a){if(e.checkedKey){for(var l=[],n=0;n<a.data.length;n++)l.push(a.data[n][e.checkedKey]);t.attr("ts-selected",l.join(","))}e.done(t,a),b.remove(),delete c.cache[p],y=[]}if(i.stopPropagation(),a("div.tableSelect").length>=1)return!1;var u=t.offset().top+t.outerHeight()+"px",f=t.offset().left+"px",p="tableSelect_table_"+(new Date).getTime(),b='<div class="tableSelect layui-anim layui-anim-upbit" style="left:'+f+";top:"+u+';border: 1px solid #d2d2d2;background-color: #fff;box-shadow: 0 2px 4px rgba(0,0,0,.12);padding:10px 10px 0 10px;position: absolute;z-index:66666666;margin: 5px 0;border-radius: 2px;min-width:530px;">';b+='<div class="tableSelectBar">',b+='<form class="layui-form" action="" style="display:inline-block;">',b+='<input style="display:inline-block;width:190px;height:30px;vertical-align:middle;margin-right:-1px;border: 1px solid #C9C9C9;" type="text" name="'+e.searchKey+'" placeholder="'+e.searchPlaceholder+'" autocomplete="off" class="layui-input"><button class="layui-btn layui-btn-sm layui-btn-primary tableSelect_btn_search" lay-submit lay-filter="tableSelect_btn_search"><i class="layui-icon layui-icon-search"></i></button>',b+="</form>",b+='<button style="float:right;" class="layui-btn layui-btn-sm tableSelect_btn_select">选择<span></span></button>',b+="</div>",b+='<table id="'+p+'" lay-filter="'+p+'"></table>',b+="</div>",b=a(b),a("body").append(b);var y=[];e.table.elem="#"+p,e.table.id=p,e.table.done=function(e,t,a){r(e,t,a),o(e,t,a),n(e,t,a)};var g=c.render(e.table);c.on("radio("+p+")",function(t){e.checkedKey&&(y=c.checkStatus(p).data),d(c.checkStatus(p).data.length)}),c.on("checkbox("+p+")",function(t){function a(){for(var t="",a=0;a<c.cache[p].length;a++)c.cache[p][a].LAY_CHECKED||(t=c.cache[p][a][e.checkedKey]);return t}if(e.checkedKey){if(t.checked)for(var l=0;l<c.checkStatus(p).data.length;l++)y.push(c.checkStatus(p).data[l]);else if("all"==t.type)for(var n=0;n<c.cache[p].length;n++)for(var l=0;l<y.length;l++)y[l][e.checkedKey]==c.cache[p][n][e.checkedKey]&&y.splice(l,1);else for(var i=t.data[e.checkedKey]||a(),l=0;l<y.length;l++)y[l][e.checkedKey]==i&&y.splice(l,1);y=h(y,e.checkedKey),d(y.length)}else d(c.checkStatus(p).data.length)});var k=t.offset().top+t.outerHeight()+b.outerHeight()-a(window).scrollTop()>a(window).height(),v=t.offset().left+b.outerWidth()>a(window).width();k&&b.css({top:"auto",bottom:"0px"}),v&&b.css({left:"auto",right:"5px"}),l.on("submit(tableSelect_btn_search)",function(e){return g.reload({where:e.field,page:{curr:1}}),!1}),c.on("rowDouble("+p+")",function(e){var t={data:[e.data]};s(t)}),b.find(".tableSelect_btn_select").on("click",function(){var e=c.checkStatus(p);y.length>1&&(e.data=y),s(e)}),a(document).mouseup(function(t){var l=a(""+e.elem+",.tableSelect");l.is(t.target)||0!==l.has(t.target).length||(b.remove(),delete c.cache[p],y=[])})})},n.prototype.hide=function(e){a(".tableSelect").remove()};var n=new n;window.top==window.self&&a(window).scroll(function(){n.hide()}),e(t,n)});